<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>找回密码</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
<div class="form-container common-card-style" style="margin-top: 100px;">
    <h2>重置密码</h2>
    <form id="resetForm">
        <div class="form-group">
            <label>注册邮箱：</label>
            <div style="display: flex; gap: 10px;">
                <input type="email" id="email" placeholder="请输入邮箱" required>
                <button type="button" id="sendBtn" class="btn" style="width: 120px; font-size: 13px;">获取验证码</button>
            </div>
        </div>
        <div class="form-group">
            <label>验证码：</label>
            <input type="text" id="code" placeholder="请输入6位验证码" required>
        </div>
        <div class="form-group">
            <label>新密码：</label>
            <input type="password" id="newPassword" placeholder="请输入新密码" required>
        </div>
        <div class="form-group">
            <label>确认密码：</label>
            <input type="password" id="confirmPassword" placeholder="请再次输入新密码" required>
        </div>

        <div class="form-actions">
            <button type="button" id="submitResetBtn" class="btn btn-primary" style="width: 100%;">确认重置</button>
        </div>
        <div class="form-footer">
            <a href="login.html" class="login-link">返回登录</a>
        </div>
    </form>
</div>

<script>
    const sendBtn = document.getElementById('sendBtn');
    const submitBtn = document.getElementById('submitResetBtn');

    // 发送验证码
    sendBtn.addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        if(!email) return alert('请先填写邮箱');

        sendBtn.disabled = true;
        sendBtn.innerText = '发送中...';

        try {
            const res = await fetch('/api/send-email-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: email})
            });
            const data = await res.json();
            if(data.success) {
                alert(data.message || '验证码已发送'); // 使用后端返回的消息更准确
                // 倒计时逻辑
                let count = 60;
                const timer = setInterval(() => {
                    sendBtn.innerText = `${count--}s后重发`;
                    if(count < 0) {
                        clearInterval(timer);
                        sendBtn.disabled = false;
                        sendBtn.innerText = '获取验证码';
                    }
                }, 1000);
            } else {
                alert(data.message);
                sendBtn.disabled = false;
                sendBtn.innerText = '获取验证码';
            }
        } catch(e) {
            console.error(e);
            alert('网络错误');
            sendBtn.disabled = false;
            sendBtn.innerText = '获取验证码';
        }
    });

    // 提交重置
    submitBtn.addEventListener('click', async () => {
        const email = document.getElementById('email').value.trim();
        const code = document.getElementById('code').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value; // 获取确认密码

        if(!email || !code || !newPassword || !confirmPassword) {
            return alert('请填写完整信息');
        }

        // 新增：校验两次密码是否一致
        if (newPassword !== confirmPassword) {
            return alert('两次输入的密码不一致，请重新输入！');
        }

        if (newPassword.length < 6) {
            return alert('密码长度不能少于6位');
        }

        try {
            const res = await fetch('/api/reset-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, code, newPassword})
            });
            const data = await res.json();
            if(data.success) {
                alert('密码修改成功！');
                window.location.href = 'login.html';
            } else {
                alert(data.message);
            }
        } catch(e) {
            console.error(e);
            alert('网络错误');
        }
    });
</script>
</body>
</html>