<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>待买清单 - 美食天地</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        .list-container { max-width: 600px; margin: 30px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-top: 5px solid #f7941e; }
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .input-group input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        .input-group input:focus { border-color: #f7941e; }

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .list-header h3 { color: #664b2e; margin: 0; }

        .shopping-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; transition: 0.3s; }
        .shopping-item:hover { background-color: #fcfcfc; }

        /* 自定义复选框样式 */
        .check-circle {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%;
            margin-right: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; color: white; font-size: 14px;
        }
        .shopping-item.bought .check-circle { background-color: #8cc63f; border-color: #8cc63f; }
        .shopping-item.bought .item-text { text-decoration: line-through; color: #999; }

        .item-text { flex: 1; color: #333; font-size: 16px; }
        .item-qty { background: #f0f0f0; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #666; margin-right: 10px; }
        .delete-btn { color: #ff6b6b; cursor: pointer; font-size: 16px; opacity: 0.6; transition: 0.2s; border: none; background: none; }
        .delete-btn:hover { opacity: 1; transform: scale(1.1); }

        .empty-tip { text-align: center; color: #999; padding: 30px; }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-title"><i class="fas fa-utensils"></i><span>美食天地</span></div>
    <div class="nav-center">
        <ul class="nav-links">
            <li><a href="index.html">首页</a></li>
            <li><a href="shopping_list.html" style="background-color: rgba(255,255,255,0.2);">购物清单</a></li>
            <li><a href="market.html">食材商城</a></li>
            <li><a href="profile.html">个人中心</a></li>
        </ul>
    </div>
</nav>

<div class="page-container">
    <div class="list-container">
        <h2 style="text-align: center; color: #664b2e; margin-bottom: 20px;"><i class="fas fa-clipboard-list"></i> 我的待买清单</h2>

        <div class="input-group">
            <input type="text" id="itemName" placeholder="添加新物品 (如: 鸡蛋)" onkeypress="if(event.keyCode==13) document.getElementById('qtyName').focus()">
            <input type="text" id="qtyName" placeholder="用量 (选填)" style="width: 100px;" onkeypress="if(event.keyCode==13) addItem()">
            <button class="btn btn-primary" onclick="addItem()"><i class="fas fa-plus"></i></button>
        </div>

        <div class="list-header">
            <h3>待买</h3>
        </div>
        <div id="todoList"></div>

        <div class="list-header" style="margin-top: 30px;">
            <h3>已买</h3>
            <button class="btn btn-sm" onclick="clearBought()" style="color: #666; background: #eee; padding: 2px 8px; font-size: 12px;">清空已买</button>
        </div>
        <div id="boughtList"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', loadList);

    // 加载列表
    async function loadList() {
        try {
            const res = await fetch('/api/shopping-list/list');
            if(res.status === 401) {
                window.location.href = 'login.html';
                return;
            }
            const list = await res.json();
            renderLists(list);
        } catch(e) { console.error(e); }
    }

    // 渲染
    function renderLists(list) {
        const todoContainer = document.getElementById('todoList');
        const boughtContainer = document.getElementById('boughtList');
        todoContainer.innerHTML = '';
        boughtContainer.innerHTML = '';

        if(list.length === 0) {
            todoContainer.innerHTML = '<div class="empty-tip">清单空空如也，快去添加食材吧~</div>';
            return;
        }

        list.forEach(item => {
            const html = `
                <div class="shopping-item ${item.isBought ? 'bought' : ''}">
                    <div class="check-circle" onclick="toggleStatus(${item.id}, ${!item.isBought})">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="item-text">${item.name}</span>
                    ${item.quantity ? `<span class="item-qty">${item.quantity}</span>` : ''}
                    <button class="delete-btn" onclick="deleteItem(${item.id})"><i class="fas fa-times"></i></button>
                </div>
            `;
            if(item.isBought) boughtContainer.insertAdjacentHTML('beforeend', html);
            else todoContainer.insertAdjacentHTML('beforeend', html);
        });
    }

    // 添加
    async function addItem() {
        const nameInput = document.getElementById('itemName');
        const qtyInput = document.getElementById('qtyName');
        const name = nameInput.value.trim();
        const quantity = qtyInput.value.trim();

        if(!name) return;

        await fetch('/api/shopping-list/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, quantity })
        });

        nameInput.value = '';
        qtyInput.value = '';
        loadList();
    }

    // 切换状态
    async function toggleStatus(id, isBought) {
        await fetch('/api/shopping-list/status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, isBought })
        });
        loadList();
    }

    // 删除
    async function deleteItem(id) {
        await fetch('/api/shopping-list/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id })
        });
        loadList();
    }

    // 清理已买
    async function clearBought() {
        if(!confirm('确定清空所有已买物品吗？')) return;
        await fetch('/api/shopping-list/clear-bought', { method: 'POST' });
        loadList();
    }
</script>
</body>
</html>